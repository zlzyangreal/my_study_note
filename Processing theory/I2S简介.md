Inter-IC Sount Bus(I2S)是飞利浦半导体公司(现为恩智浦半导体公司)针对数字音频设备之间的音频数据传输而制定的一种总线标准。在飞利浦公司的I2S标准中，既规定了硬件接口规范，也规定了数字音频数据的格式。
### 1.1. 数字音频技术

现实生活中的声音是通过一定介质传播的连续的波，它可以由周期和振幅两个重要指标描述。 正常人可以听到的声音频率范围为20Hz~20KHz。现实存在的声音是模拟量， 这对声音保存和长距离传输造成很大的困难，一般的做法是把模拟量转成对应的数字量保存， 在需要还原声音的地方再把数字量的转成模拟量输出，参考 图1。

![图 36_0_1 音频转换过程](https://doc.embedfire.com/mcu/stm32/f4/hal_general/zh/latest/_images/image120.png)

图 1 音频转换过程

模拟量转成数字量过程，一般可以分为三个过程，分别为采样、量化、编码，参考 图2， 可以想象得到采样频率越高最后得到的结果就与源声音越吻合，但此时采样数据量越越大， 一般使用44.1KHz采样频率即可得到高保真的声音。每条蓝色虚线长度决定着该时刻源声音的量化值， 该量化值有另外一个概念与之挂钩，就是量化位数。量化位数表示每个采样点用多少位表示数据范围， 常用有16bit、24bit或32bit，位数越高最后还原得到的音质越好，数据量也会越大。

![图 36_0_2 声音数字化过程](https://doc.embedfire.com/mcu/stm32/f4/hal_general/zh/latest/_images/image224.png)

图 2 声音数字化过程

WM8978是一个低功耗、高质量的立体声多媒体数字信号编译码器，集成DAC和ADC，可以实现声音信号量化成数字量输出，也可以实现数字量音频数据转换为模拟量声音驱动扬声器。这样使用WM8978芯片解决了声音与数字量音频数据转换问题，并且通过配置WM8978芯片相关寄存器可以控制转换过程的参数，比如采样频率，量化位数，增益、滤波等等。

WM8978芯片是一个音频编译码器，但本身没有保存音频数据功能，它只能接收其它设备传输过来的音频数据进行转换输出到扬声器，或者把采样到的音频数据输出到其它具有存储功能的设备保存下来。该芯片与其他设备进行音频数据传输接口就是I2S协议的音频接口。

### 1.2. I2S总线接口

I2S总线接口有3个主要信号，但只能实现数据半双工传输，后来为实现全双工传输有些设备增加了扩展数据引脚。STM32f4xx系列控制器支持扩展的I2S总线接口。
1. SD(Serial Data)：串行数据线，用于发送或接收两个时分复用的数据通道上的数据(仅半双工模式)，如果是全双工模式，该信号仅用于发送数据。
2. WS(Word Select)：字段选择线，也称帧时钟(LRC)线，表明当前传输数据的声道，不同标准有不同的定义。WS线的频率等于采样频率(FS)。
3. CK(Serial Clock)：串行时钟线，也称位时钟(BCLK)，数字音频的每一位数据都对应有一个CK脉冲，它的频率为：2`*`采样频率`*`量化位数，2代表左右两个通道数据。
4. ext_SD(extend Serial Data)：扩展串行数据线，用于全双工传输的数据接收。
另外，有时为使系统间更好地同步，还要传输一个主时钟(MCK)，STM32F4xx系列控制器固定输出为256* FS。
### 1.3. 音频数据传输协议标准

随着技术的发展，在统一的I2S硬件接口下，出现了多种不同的数据格式，可分为左对齐(MSB)标准、右对齐(LSB)标准、I2S Philips标准。另外，STM32F4xx系列控制器还支持PCM(脉冲编码调)音频传输协议。下面以STM32F4xx系列控制器资源解释这四个传输协议。

STM32f4xx系列控制器(**DSP28335也为16位，因为16位的数据精度已经足够用于大多数音频处理应用，并且可以在保持较高效率的同时提供足够的音频质量**)I2S的数据寄存器只有16bit，并且左右声道数据一般是紧邻传输，为正确得到左右两个声道数据，需要软件控制数据对应通道数据写入或读取。另外，音频数据的量化位数可能不同，控制器支持16bit、24bit和32bit三种数据长度，因为数据寄存器是16bit的，所以对于24bit和32bit数据长度需要发送两个。为此，可以产生四种数据和帧格式组合：
- 将16位数据封装在16位帧中
- 将16位数据封装在32位帧中
- 将24位数据封装在32位帧中
- 将32位数据封装在32位帧中
当使用32位数据包中的16位数据时，前16位(MSB)为有效位，16位LSB被强制清零，无需任何软件操作或DMA请求（只需一个读/写操作）。如果程序使用DMA传输(一般都会用)，则24位和32位数据帧需要对数据寄存器执行两次DMA操作。24位的数据帧，硬件会将8位非有效位扩展到带有0位的32位。对于所有数据格式和通信标准而言，始终会先发送最高有效位(MSB优先)。
#### 1.3.1. I2S Philips标准

使用WS信号来指示当前正在发送的数据所属的通道，为0时表示左通道数据。 该信号从当前通道数据的第一个位(MSB)之前的一个时钟开始有效。发送方在时钟信号(CK)的下降沿改变数据， 接收方在上升沿读取数据。WS信号也在SCK的下降沿变化。参考 图3， 为24bit数据封装在32bit帧传输波形。正如之前所说， WS线频率对于采样频率FS，一个WS线周期包括发送左声道和右声道数据， 在图中实际需要64个CK周期来完成一次传输。

![图 36_0_3 I2S Philips标准24bit传输](https://doc.embedfire.com/mcu/stm32/f4/hal_general/zh/latest/_images/image318.png)

图 3 I2S Philips标准24bit传输

#### 37.1.3.2. 左对齐标准

在WS发生翻转同时开始传输数据，参考 图4，为24bit数据封装在32bit帧传输波形。 该标准较少使用。注意此时WS为1时，传输的是左声道数据，这刚好与I2S Philips标准相反。

![图 36_0_4 左对齐标准24bit传输](https://doc.embedfire.com/mcu/stm32/f4/hal_general/zh/latest/_images/image417.png)

图 4 左对齐标准24bit传输

#### 1.3.3. 右对齐标准

与左对齐标准类似，参考 图5，为24bit数据封装在32bit帧传输波形。

![图36_0_5 右对齐标准24bit传输](https://doc.embedfire.com/mcu/stm32/f4/hal_general/zh/latest/_images/image511.png)

图5 右对齐标准24bit传输

#### 1.3.4. PCM标准

PCM即脉冲编码调制，模拟语音信号经过采样量化以及一定数据排列就是PCM了。WS不再作为声道数据选择。它有两种模式，短帧模式和长帧模式，以WS信号高电平保持时间为判别依据，长帧模式保持13个CK周期，短帧模式只保持1个CK周期，可以通过相关寄存器位选择。如果有多通道数据是在一个WS周期内传输完成的，传完左声道数据就紧跟发送右声道数据。 图6 为单声道数据16bit扩展到32bit数据帧发送波形。

![图36_0_6 PCM标准16bit传输](https://doc.embedfire.com/mcu/stm32/f4/hal_general/zh/latest/_images/image613.png)

图6 PCM标准16bit传输